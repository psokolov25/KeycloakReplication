Ты — опытный DevOps/архитектор, отлично разбирающийся в Keycloak 24, PostgreSQL 15/16, Docker и docker-compose, а также в логической репликации PostgreSQL и внутренней архитектуре кешей Keycloak (Infinispan, user/role/realm caches и т.п.).

Твоя задача — ВЫДАТЬ ПОЛНЫЙ, РАБОТОСПОСОБНЫЙ НАБОР КОНФИГУРАЦИЙ, СКРИПТОВ И ИНСТРУКЦИЙ для развёртывания Keycloak в архитектуре «Центр–Филиал» с логической репликацией «долгоиграющих» сущностей, с учётом проблем кеширования и логов, с возможностью проверки отказоустойчивости филиала и ОБЯЗАТЕЛЬНОЙ выдачей zip-АРХИВА со всем проектом (включая файл с полным текстом промта и его последующих дополнений).

ОЧЕНЬ ВАЖНО:  
1. Количество файлов проекта должно быть разумно минимальным, но не в ущерб читаемости и поддерживаемости (в приоритете 2–3 docker-compose файла + 1–3 SQL/скрипта там, где без этого никак).  
2. В КАЖДом ОТВЕТЕ ассистент обязан:
   - формировать и отдавать zip-архив со ВСЕМИ файлами проекта, даже если часть файлов не менялась;
   - выводить в тексте ответа АКТУАЛЬНЫЙ ПРОМТ (такой, как его нужно использовать в следующий раз), уже с учётом:
     - исправленных в ходе работы недочётов;
     - добавленных дополнительных фич и уточнений.
3. В каждом ответе ассистент должен выводить актуальный текст промта как отдельный markdown-исходник (в fenced-блоке с указанием языка `markdown`), чтобы его можно было сразу копировать и использовать в последующих запусках.
4. В состав проекта ОБЯЗАТЕЛЬНО должен входить файл `PROMPT.full.md` (или `PROMPT.txt`) с ПОЛНЫМ актуальным текстом промта (исходный текст задания + все добавленные уточнения/расширения, включая текущий блок требований).
5. В актуальных примерах `docker compose` версии 2 атрибут `version` в `docker-compose.yml` считается устаревшим и игнорируется. Чтобы избежать лишних WARN, в проекте НЕ следует использовать строку `version: "3.9"` в заголовке файлов `docker-compose.*.yml`.
6. Для проверки состояния подписки на филиале рекомендуется использовать универсальную команду:
   `SELECT * FROM pg_stat_subscription;`
   вместо обращения к конкретному полю `status`, которое может отсутствовать в конкретной версии PostgreSQL.
7. repl-init НЕ должен опираться только на жёсткий `sleep`, а обязан проверять готовность схемы Keycloak:
   - перед созданием PUBLICATION и SUBSCRIPTION необходимо дождаться появления ключевых таблиц (например, `public.realm` и `public.user_entity`, а также `public.client`) как на центре, так и на филиале;
   - скрипт должен реализовывать опрос БД с ограниченным тайм-аутом (`REPL_INIT_MAX_WAIT`) и шагом ожидания (`REPL_INIT_SLEEP_STEP`);
   - только после этого допускается запуск SQL-скриптов настройки логической репликации.
8. Если repl-init завершается по тайм-ауту на ожидании таблиц (например, `public.realm` или `public.client` на центре), это должно восприниматься как индикатор того, что Keycloak не выполнил свои миграции и/или не смог подключиться к БД. В промте и README необходимо явно описать порядок диагностики:
   - просмотр логов `keycloak-center` на предмет ошибок миграций/подключения к БД;
   - прямую проверку наличия таблиц Keycloak в `pg-center` через `information_schema.tables`;
   - сверку параметров подключения к БД в docker-compose (`POSTGRES_*` vs `KC_DB_*`).
9. Для проверки готовности схемы в repl-init следует использовать запрос к `information_schema.tables`, а не `to_regclass(...)`, чтобы избежать проблем с search_path и различиями в поведении между версиями PostgreSQL. В скрипте проверки необходимо выполнять запрос вида:
   `SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'realm' LIMIT 1;`.
10. Перед выдачей очередной версии проекта ассистент обязан максимально тщательно перепроверять весь генерируемый код и конфигурации (bash, SQL, YAML, JSON) на синтаксические и очевидные логические ошибки:
    - для shell-скриптов — внимательно проверять корректность функций, кавычек, подстановок переменных и отсутствие «обрезков» старого кода;
    - для Docker Compose (YAML) — следить за корректным отступом, отсутствием устаревших конструкций и несуществующих ссылок на сети/volume’ы;
    - для SQL — проверять базовый синтаксис и совместимость с используемой версией PostgreSQL;
    - для JSON/realm-экспортов — проверять корректное форматирование и структуру.
    Любые изменения должны сопровождаться внутренней самопроверкой, чтобы минимизировать риск возникновения синтаксических ошибок, существенно замедляющих интеграцию на стенде.
11. В логах `repl-init` допускается появление временных сообщений `connection refused` при попытке подключения к `pg-center` / `pg-branch`, если PostgreSQL ещё не успел полностью стартовать. Скрипт и архитектура должны рассматривать такие сообщения как ожидаемые в первые секунды/десятки секунд старта и продолжать повторы до тех пор, пока:
    - либо подключение не станет успешным и в `information_schema.tables` не появятся таблицы `realm`, `user_entity` и `client`;
    - либо не будет достигнут таймаут `REPL_INIT_MAX_WAIT`, после которого скрипт завершится с явной ошибкой ожидания.
12. Скрипт настройки SUBSCRIPTION на филиале (`branch-subscription-longtime.sql`) должен быть максимально простым и безопасным:
    - не содержать прямых `ALTER TABLE` по таблицам схемы Keycloak;
    - не ссылаться на конкретные имена таблиц (особенно устаревшие, вроде `realm_social_config` или `application_default_roles`), которые могут отсутствовать в целевой версии Keycloak;
    - заниматься только управлением подпиской (`DISABLE`, `DROP SUBSCRIPTION`, `CREATE SUBSCRIPTION ...`).
    Вся логика выбора таблиц для репликации и настройки `REPLICA IDENTITY` должна находиться на стороне центра в `center-publication-longtime.sql` и работать через динамический обход каталога (pg_catalog / information_schema), без жёсткого кодирования устаревших имён таблиц.
13. При появлении в логах Keycloak (особенно `keycloak-branch`) обобщённого сообщения `ERROR: Failed to start server in (development) mode` в проекте и документации должны быть описаны:
    - шаги по включению подробного логирования (`KC_LOG_LEVEL=DEBUG` и/или параметр `--verbose` в команде запуска);
    - рекомендации просматривать несколько десятков строк выше этой ошибки в логах контейнера;
    - список типичных причин (ошибки импорта реалма, проблемы доступа к БД, конфликты конфигурации), на которые следует обратить внимание при анализе.
14. Во всех docker-compose файлах проекта (`docker-compose.dev.yml`, `docker-compose.center.dev.yml`, `docker-compose.branch.dev.yml`) для сервисов Keycloak (`keycloak-center`, `keycloak-branch` и аналогичных) должен быть явно задан повышенный уровень логирования:
    - переменная окружения `KC_LOG_LEVEL` должна быть установлена в значение `DEBUG` для упрощения диагностики проблем на DEV-стендах;
    - при необходимости допускается временное повышение до `TRACE`, но базовым значением по умолчанию в проекте является `DEBUG`.
15. Во всех docker-compose файлах проекта порты HTTP Keycloak должны быть явно проброшены наружу:
    - в `docker-compose.dev.yml`:
        - `keycloak-center` — на порт хоста `8080:8080`;
        - `keycloak-branch` — на порт хоста `8081:8080`, чтобы оба инстанса можно было запускать на одной машине;
    - в `docker-compose.center.dev.yml`:
        - `keycloak-center` — на порт хоста `8080:8080`;
    - в `docker-compose.branch.dev.yml`:
        - `keycloak-branch` — на порт хоста `8080:8080` (рассчитано на запуск на отдельном хосте).
    Отсутствие проброса портов у сервисов Keycloak в compose-файлах недопустимо для DEV-стендов и должно считаться ошибкой конфигурации.
16. Перед выдачей проекта ассистент обязан явно проверить, что во всех docker-compose файлах заданы корректные пробросы портов HTTP для сервисов Keycloak:
    - `docker-compose.dev.yml`:
        - сервис `keycloak-center` имеет `ports: ["8080:8080"]`;
        - сервис `keycloak-branch` имеет `ports: ["8081:8080"]`;
    - `docker-compose.center.dev.yml`:
        - сервис `keycloak-center` имеет `ports: ["8080:8080"]`;
    - `docker-compose.branch.dev.yml`:
        - сервис `keycloak-branch` имеет `ports: ["8080:8080"]`.
    Отсутствие или некорректный проброс портов считается критической ошибкой конфигурации DEV-стенда.
17. В каждом ответе всегда выдавать полный проект: zip-архив со всеми файлами (включая неизменённые) и актуальным `PROMPT.full.md`.
18. В `repl-init` после запуска следует:
    - выполнить начальную паузу (по умолчанию 400 секунд, параметризуемую через `REPL_INIT_INITIAL_SLEEP`), чтобы дать Keycloak время полностью выполнить миграции;
    - после паузы циклически обходить список «долгоиграющих» таблиц (минимум: `realm`, `user_entity`, `client`, `role_`, `group_`, `user_group_membership`, `user_role_mapping`, `client_role`, `client_scope`, `identity_provider`, `identity_provider_mapper`) на центре и филиале и проверять, что они созданы, пока либо все не появятся, либо не наступит тайм-аут `REPL_INIT_MAX_WAIT`.
19. В проект должна быть реализована стартовая настройка центра:
    - при первом запуске Keycloak центра должен автоматически импортировать стартовый Realm (например, `aritmos_platform`);
    - в этом Realm должны быть:
      - технический пользователь `admin` с полным набором прав в рамках реалма;
      - группа `REGION` с атрибутом `type=region`;
      - базовый набор стартовых ролей (включая административные роли для технического пользователя);
    - импорт должен выполняться средствами Keycloak (`start-dev --import-realm`) из JSON-файла, входящего в проект, чтобы развёртывание DEV-стенда не требовало ручной подготовки реалма и пользователя.
20. В скрипте `branch-subscription-longtime.sql` НЕ допускается выполнять `DROP SUBSCRIPTION` внутри `DO`/функции, так как команда `DROP SUBSCRIPTION` не может выполняться внутри транзакционного блока. Скрипт должен:
    - использовать `DO` только для безопасного `ALTER SUBSCRIPTION ... DISABLE` при наличии подписки;
    - выполнять `DROP SUBSCRIPTION IF EXISTS keycloak_longtime_sub;` отдельным оператором вне `DO`;
    - после этого создавать подписку `CREATE SUBSCRIPTION ...` с параметрами `copy_data=true`, `create_slot=true`, `slot_name='keycloak_longtime_slot'`.
21. В сценарии `docker-compose.dev.yml` (центр+филиал на одном хосте) запуск `keycloak-branch` должен происходить ТОЛЬКО после успешного завершения `repl-init`, чтобы:
    - к моменту старта Keycloak филиала в БД `pg-branch` уже были скопированы все «долгоиграющие» сущности (в том числе стартовый realm `aritmos_platform`);
    - Keycloak филиала с самого первого запуска построил кэши поверх уже реплицированных данных, а не требовал ручного рестарта для подхвата новых realm/пользователей.
    Для этого в `docker-compose.dev.yml` необходимо настроить `depends_on` для `keycloak-branch` с условием `service_completed_successfully` по отношению к сервису `repl-init`.
22. Скрипт `branch-subscription-longtime.sql` НЕ должен содержать ссылок на конкретные таблицы схемы Keycloak (такие как `resource_server_scope`, `application_default_roles` и т.п.) и не должен выполнять `ALTER TABLE` над ними. Любая логика, завязанная на состав таблиц, реализуется ТОЛЬКО на стороне центра в `center-publication-longtime.sql` через динамический обход `information_schema`/`pg_catalog`. На стороне филиала `branch-subscription-longtime.sql` управляет ТОЛЬКО подпиской (`DISABLE` при наличии, `DROP SUBSCRIPTION IF EXISTS`, затем `CREATE SUBSCRIPTION ...`).
23. Плейсхолдеры в файлах проекта (заглушки вместо реального содержимого) недопустимы: ассистент всегда должен выдавать в архиве полные, рабочие версии всех файлов (bash, SQL, docker-compose, JSON и др.), без замены их на «placeholder» или аналогичные заглушки.

Если среда выполнения поддерживает создание файлов и архивов:
- создай структуру проекта (директории и файлы) с минимально необходимым набором артефактов;
- запакуй всё в zip-архив (например, `keycloak-center-branch-repl.zip`);
- дай явную ссылку/маркер для скачивания архива (например, `[download keycloak-center-branch-repl.zip](sandbox:/path/to/zip)` или аналог);
- в архиве должны быть ВСЕ файлы проекта, включая неизменённые файлы и `PROMPT.full.md`.

Если файловую систему использовать нельзя:
- выведи понятную структуру проекта и ПОЛНЫЕ содержимое всех файлов;
- добавь bash-скрипт (или набор команд), который локально создаёт все файлы и упаковывает их в zip-архив;
- `PROMPT.full.md` должен локально создаваться с полным текстом промта и его уточнений.

---

### 1. Контекст архитектуры

(далее — те же разделы про архитектуру центр–филиал, кеши, репликацию, health-check и структуру проекта, уже с учётом всех уточнений по репликации, диагностике, уровню логирования и публикации портов Keycloak)
